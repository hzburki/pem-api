# Setup Migrations using Alembic

We are going to manage all database migrations using Alembic. Alembic is a database migration tool for usage with the SQLAlchemy Database Toolkit for Python. It provides a full suite of well known database migration patterns, designed to make it as easy as possible to manage database schema changes over time.

## Installation

Install Alembic using pip:

```bash
  pip install alembic
```

## Configuration

Run the command below to create the alembic directory and .ini file:

```bash
  alembic init alembic
```

We are going to leave everything in the `alembic.ini` file as is. We will only be changing the `script_location` to `src/migrations` so all the code for the project in encapsulated inside the `src` directory. 

We also need to change the  `sqlalchemy.url` to the database connection url. Here we will need to use envrionment variables to store the database connection url, because you should not be storing the database connection url in your code. 

```ini
  [alembic]
  script_location = src/migrations
  sqlalchemy.url = ${DATABASE_URL}
```

Once we have the `.ini` file setup. We need to provide the `declarative_base` from sqlalchemy to alembic. This is done by adding the `Base` model to the `env.py`. Alembic uses this `Base` to detect changes between the mysql database and what we have in the sqlalchemy models. 

Since we have the models separated out into different files. We have to import the `Base` from each file separately and add it to the `target_metadata` variable. For example:

```python
  from ..src.models.user import Base
  from ..src.models.post import Base
  from ..src.models.comment import Base

  target_metadata = user.Base.metadata
  target_metadata = post.Base.metadata
  target_metadata = comment.Base.metadata
```

> We can write a simple script here to load read all files from the `models` table, import the models and add them to the `target_metadata` variable using a loop. 

## Creating Migrations

To create a migration, we need to run the command below:

```bash
  alembic revision --autogenerate -m "create user table"
```

This will create a new migration file in the `src/migrations/versions` directory. The file will have a name like `1234567890_create_user_table.py`. The `--autogenerate` tag will use your sqlalchemy models to detect changes between the database and the models and will generate the migration code for you.

> **Note**: Alembic was not able to detect the `ON_DELETE` and `ON_UPDATE` options. I had to add them manually. It maybe smart to always read the code generated by Alembic and make sure everything is added. 

## Running Migrations 

To run the migrations, we need to run the command below:

```bash
  alembic upgrade head
  # or
  alembic upgrade 1234567890
```

The `head` tag will run all the migrations. You can also specify the migration version you want to run to.

## Reverting Migrations

To revert the migrations, we need to run the command below:

```bash
  alembic downgrade -1
  # or
  alembic downgrade 1234567890
```

The `-1` tag will revert the last migration. You can specify any number you'd like e.g. `-3` will revert the last three migrations. You can also specify the migration version you want to revert to.

